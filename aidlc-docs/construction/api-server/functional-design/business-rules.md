# Business Rules - API Server

## 1. 인증 규칙

### 관리자 로그인 제한
- 5회 연속 실패 시 5분간 로그인 차단
- 차단 판정: 최근 5분 내 실패 횟수 >= 5
- 성공 시 실패 카운트 리셋 (해당 기간 기록 무효화)

### JWT 토큰 정책
- Admin 토큰 만료: 16시간
- Table 토큰 만료: 24시간
- 자동 갱신: 만료 1시간 전 요청 시 새 토큰 발급

### 테이블 비밀번호
- 형식: 4자리 숫자 PIN (0000~9999)
- 검증: `/^\d{4}$/`

---

## 2. 주문 규칙

### 주문 번호
- 형식: 순차 정수 (AUTOINCREMENT)
- 범위: 1부터 시작

### 주문 상태 전환
```
pending → preparing → completed (순방향만 허용)
```
- 허용: pending→preparing, preparing→completed
- 불허: 역방향 전환, 단계 건너뛰기

### 동시 주문
- 같은 테이블에서 동시 주문 허용
- 제한 없음

### 주문 삭제
- 방식: Soft Delete (deletedAt 필드 설정)
- 조회 시 deletedAt IS NULL 조건 적용

---

## 3. 메뉴 규칙

### 가격 범위
- 최소: 1,000원
- 최대: 100,000원
- 검증: `1000 <= price <= 100000`

### 이미지 URL 검증
- 형식 검증: `http://` 또는 `https://`로 시작
- 존재 검증: HTTP HEAD 요청으로 이미지 존재 확인
- 실패 시: 400 VALIDATION_ERROR 반환

### 수량 범위
- 최소: 1
- 최대: 99
- 검증: `1 <= quantity <= 99`

---

## 4. 카테고리 규칙

### 삭제 제약
- 메뉴가 존재하는 카테고리는 삭제 불가
- 삭제 시도 시: 400 VALIDATION_ERROR (CATEGORY_HAS_MENUS)

---

## 5. 테이블/세션 규칙

### 세션 ID 생성
- 형식: UUID v4

### 세션 라이프사이클
1. 테이블 로그인 시 세션 생성 (없으면)
2. 주문 누적
3. 관리자 "이용 완료" 시 세션 종료

### 테이블 상태
- `active`: 현재 세션 진행 중
- `inactive`: 세션 없음

---

## 6. 데이터 보관 규칙

### 과거 주문 내역
- 보관 기간: 영구 보관
- 삭제: 수동 삭제만 가능

---

## 7. SSE 규칙

### 재연결 처리
- 재연결 시 최신 상태만 전송
- 누락 이벤트 버퍼링 없음
- 클라이언트는 재연결 후 전체 데이터 재조회 권장

---

## 8. 입력 검증 규칙

| 필드 | 규칙 |
|------|------|
| storeId | UUID 형식, 필수 |
| tableNumber | 정수, 1~99 |
| password (table) | 4자리 숫자 |
| password (admin) | 최소 4자 |
| nameKo/nameEn | 1~100자 |
| descKo/descEn | 0~500자 |
| price | 1,000~100,000 |
| quantity | 1~99 |
| imageUrl | http/https URL 또는 빈 문자열 |
